<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>  
<!DOCTYPE html>
<html lang="ko">
<head>
<title>schedule list</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<style type="text/css">
	p.pageTitle {font-size: 3em; color: #c68c53; font-weight: bolder; margin-top: -20px; margin-bottom: -5px;}
	.noticeBox p {font-size: 13px; color: #737373; font-weight: bolder; margin: 10px;}
	
	select[name=searchBy] {font-size: 12px;}
	
	table th, table td {padding: 3px;}
	.listHead th {text-align: center; font-size: 12px; color: #737373;}
	.listTop a:visited {color: #666666; text-decoration: underline;}
	.listTop a:hover {color: #ac7339; text-decoration: underline;}
	.listTop td {text-align: center; font-size: 12px; color: #737373;}
	.listMiddle td {text-align: center; font-size: 12px; color: #737373;}
	.listMiddle a:link {color: #666666; text-decoration: none;}
	.listMiddle a:visited {color: #666666; text-decoration: underline;}
	.listMiddle a:hover {color: #ac7339; text-decoration: underline;}
	td[id^=title-]:hover {color: #ac7339; text-decoration: underline;}
	
	.pagination a:link {color: #737373; text-decoration: none;}
	.pagination a:visited {color: #737373; text-decoration: none;}
   	.pagination a.active {background-color: #c68c53; color: #ffffff;}
	.pagination a:hover:not(.active) {color: #c68c53;}	
	
	.detailHead th, .detailHead span {text-align: left; font-size: 12px; color: #737373;}
	.detailLoginReply th, .detailLoginReply span {text-align: left; font-size: 12px; color: #737373;}
	
	.topJoinList a:link {font-size: 13px; color: #666666; text-decoration: none;}
	.topJoinList a:visited {color: #666666;}
	.topJoinList a:hover {color: #ac7339; text-decoration: underline;}
	.topLikeList a:link {font-size: 13px; color: #666666; text-decoration: none;}
	.topLikeList a:visited {color: #666666;}
	.topLikeList a:hover {color: #ac7339; text-decoration: underline;}
	  
</style>
<body>
<jsp:include page="../include/header.jsp">
	<jsp:param name="header" value="together"/>
</jsp:include>
<br/>
<div class="container" style="width: 60%; min-height: 740px;">
	<div class="row">
		<div class="col-sm-8" id="leftSection">
			<p class="pageTitle" id="locationTop">동행게시판</p>
			<div class="row noticeBox" style="border: 2px solid #c68c53; border-radius: 7px;">
				<p><img src="/resources/images/logo/peanutbw.png" width="20px;" /> 땅콩플래너 동행게시판을 통해서 즐거운 여행의 파트너를 만나보세요!</p>
				<p><img src="/resources/images/logo/peanutbw.png" width="20px;" /> 함께하고 싶은 회원의 게시글에 <span style="color: #c68c53;">참여버튼</span>을 눌러보세요!</p>
				<p><img src="/resources/images/logo/peanutbw.png" width="20px;" /> 게시글 작성은 로그인한 회원만 가능합니다.</p>
				<p><img src="/resources/images/logo/peanutbw.png" width="20px;" /> 게시글 작성시 땅콩+3개! 댓글 작성시 땅콩+1개! <span style="color: #c68c53;">증정</span></p>
			</div>
			
			<div class="row searchBox" style="margin-top: 20px; margin-bottom: 20px;">
				<div class="col-sm-4 pull-left">
					<button class="btn btn-sm btn-default" id="newBoardBtn" style="display: block;">게시글 작성</button>
					<button class="btn btn-sm btn-warning" id="toListBtn" style="display: none;">목록으로</button>
				</div>
				<div class="col-sm-8 form-inline text-right">
					<select class="form-control" name="searchBy">
						<option value="all">::검색기준::</option>
						<option value="writer">작성자</option>
						<option value="title">제목</option>
						<option value="contents">내용</option>
						<option value="board">제목+내용</option>
					</select>
					<input class="form-control" type="text" width="200px;" name="keyword" />
					<button class="btn btn-sm btn-default" id='searchBtn'>검색</button>
				</div>
			</div>
			
			<div class="row listBox">
				<table class="table" width="100%;">
					<colgroup>
						<col width="7%">
						<col width="*">
						<col width="15%">
						<col width="15%">
						<col width="7%">
						<col width="7%">
					</colgroup>
					<thead>
						<tr class="listHead">
							<th>번호</th>
							<th style="text-align: left;">최근 일주일 인기글 ⓘ</th>
							<th>닉네임</th>
							<th>날짜</th>
							<th>조회</th>
							<th><span class="glyphicon glyphicon-thumbs-up"></span></th>
						</tr>
					</thead>
					<tbody class="listTop">
						<c:choose>
							<c:when test="${not empty topTogethers }">
								<c:forEach var="together" items="${topTogethers }">
									<tr>
										<td><img src="/resources/images/logo/peanutbw.png" width="15px;" style="opacity: 0.8;"/></td>
										<td style="text-align: left; font-size: 13px; color: #ac7339; font-weight: bolder;" id='title-${together.no }'>${together.titleWithDots }</td>
										<td><a href="../user/mypage.do?id=${together.userId }">${together.userId }</a> </td>
										<td><fmt:formatDate value="${together.createDate }" pattern="MM.dd hh:mm"/></td>
										<td>${together.view }</td>
										<td>${together.likes }</td>
									</tr>
								</c:forEach>
							</c:when>
							<c:otherwise>
								<tr>
									<td colspan="6">게시글이 존재하지않습니다.</td>
								</tr>
							</c:otherwise>
						</c:choose>
					</tbody>
					<tbody class="listMiddle"></tbody>
					<tfoot class="listBottom"></tfoot>
				</table>			
			</div>
			
			<div class="row" id="detailBox" style="display: none; margin-top: -10px;">
				<table class="table" width="100%">
					<colgroup>
						<col width="10%">
						<col width="*">
					</colgroup>
					<!-- 해당 게시글 정보 -->
					<thead class="detailHead">
						<tr>
							<th colspan="2" style="font-size: 14px; color: #000000; text-align: left; font-weight: bolder;" id="detailTitle"></th>
						</tr>
						<tr>
							<th colspan="2">
								<span id="detailWriter"></span> 
								| <span id="detailCD"></span> 
								| 조회 <span id="detailViews"></span> 
								| <span class="glyphicon glyphicon-thumbs-up"></span> <span id="detailLikes"></span>
								<span id="user-modify" style="float:right; display: none; margin-top: -3px; margin-left: 2px;"><button class="btn btn-xs btn-warning">수정</button></span>
								<span id="user-delete" style="float:right; display: none; margin-top: -3px; margin-left: 2px;"><button class="btn btn-xs btn-danger">삭제</button></span>
								<span id="user-like" style="float:right; display: none; margin-top: -3px; margin-left: 2px;"><button class="btn btn-xs btn-default" style="color: #996633;">좋아요!</button></span>
								<span id="user-unlike" style="float:right; display: none; margin-top: -3px; margin-left: 2px;"><button class="btn btn-xs btn-default" style="color: #b30000;">좋아요취소</button></span>
							</th>
						</tr>
					</thead>
					<!-- 해당 게시글내용 -->
					<tbody>
						<tr><td colspan="2" class="detailMiddle" style="font-size: 13px; height: 200px;"></td></tr>
						<tr>
							<td colspan="2">
								<span class="badge badge-lg badge-default" id="joinCnt" style="margin-bottom: -10px; margin-left: -5px;"></span>	
								<button class="btn btn-lg btn-warning" id="addJoin" style="display: none;">동행참여 <span class="glyphicon glyphicon-ok-circle"></span></button>
						 		<button class="btn btn-lg btn-danger" id="cancelJoin" style="display: none;">동행취소 <span class="glyphicon glyphicon-remove-circle"></span></button>
						 	</td>
						</tr>
					</tbody>
					<!-- 로그인 유저 댓글 작성란 -->
					<tbody class="detailLoginReply">
						<tr>
							<th colspan="2" >
								<span class="glyphicon glyphicon-thumbs-up"></span> <span id="detailLikes"></span>
								<span id="user-like" style="float:right; display: none; margin-top: -3px;"><button class="btn btn-xs btn-default" style="color: #996633;">좋아요!</button></span>	
								<span id="user-unlike" style="float:right; display: none; margin-top: -3px;"><button class="btn btn-xs btn-default" style="color: #b30000;">좋아요취소</button></span>
								| <span class="glyphicon glyphicon-comment"></span> <span id="replyCnt"></span>
							</th>
						</tr>
						<tr>
							<th style="padding-top: 16px;">
								<img src="/resources/images/profile/${LOGIN_USER.profile }" width="70px;" height="70px;" id="login-profile"/>
							</th>
							<th>
								<textarea class="form-control" rows="3" id="replyContents" style="resize: none; font-size: 12px; font-weight: lighter;"></textarea>
								<div id="addReply" style="background-color: #e6e6e6; text-align: center; font-size: 12px; height: 30px; margin-top: -2px; padding-top: 5px;">확인</div>
							</th>
						</tr>
					</tbody>
					<!-- 해당 게시글에 달린 댓글 목록 -->
					<tbody class="detailReply"></tbody>
				</table>				
			</div>
			
		</div>
		<div class="col-sm-4" id="rightSection">
			<h2 style="margin-left: 0px; padding: 10px; color: #996633; letter-spacing: -4px;">
				최근3개월 <strong>참여</strong> TOP5
			</h2>
			<div class="row topJoinList" style="margin-left: 5px;"></div>
			<h2 style="margin-left: 0px; padding: 10px; color: #996633; letter-spacing: -4px;">
				최근3개월 <strong>좋아요</strong> TOP5
			</h2>
			<div class="row topLikeList" style="margin-left: 5px;"></div>
			<div class="row topMento" style="height: 370px; margin-bottom: 0px;"></div>
		</div>	
	</div>
	
	<!-- 로그인 유저 / 관리자 확인용 -->
	<c:choose>
		<c:when test="${not empty LOGIN_USER }">
			<input type="hidden" id="loginId" value="${LOGIN_USER.id }" />
			<input type="hidden" id="loginStatus" value="${LOGIN_USER.status }" />
		</c:when>
	</c:choose>
	
</div>
<jsp:include page="../include/footer.jsp" />	
</body>
<script>
$(function() {	
	
	//공용변수
	var loginId = $('#loginId').val();
	var loginStatus = $('#loginStatus').val();
	var searchBy = 'all';
	var keyword = '';
	var repCnt;
	var bno;
	var repNo;

	var totalCnt;			//전체 게시글 수
	var totalPageNo;		//전체 페이지수 (컨텐츠수 / 20)
	var totalBlocks;		//전체 블록수 (페이지수/nav 반올림)
	var currentBlock;	//현재 블록
	var start;
	var end;
	var beginPage;			//시작 페이지
	var endPage;			//끝 페이지
	var currentPageNo = 1;
	var nav = 5;

	var $list = $('.listMiddle');
	var $paging = $('.listBottom');
	var $joinList = $('.topJoinList');
	var $likeList = $('.topLikeList');
	var $detailReply = $('.detailReply');
	
	//게시글 목록 표시
	getAllTogethers();	
	function getAllTogethers() {
		$.ajax({
			type: 'GET',
			url: '/together/getAllTogethers.do',
			data: {by: searchBy, key: keyword},
			dataType: 'json',
			async: false,
			success: function(result) {
				$list.empty();
				$paging.empty();
 				start = (currentPageNo-1)*20;
				end = (currentPageNo*20);
				
				var rows;
				if(result.length != 0) {
					totalCnt = result.length;
					totalPageNo = Math.ceil(totalCnt/20);
					if(currentPageNo == totalPageNo){
						end = result.length
					}
					
					for(var i=start; i<end; i++){
						rows += "<tr>";
						rows += "<td>"+result[i].no+"</td>";
						rows += "<td style='text-align: left; font-size: 13px;' id='title-"+result[i].no+"'>"+result[i].titleWithDots+"</td>";
						rows += "<td><a href='../user/mypage.do?id="+result[i].userId+"'>"+result[i].userId+"</a></td>";
						rows += "<td>"+result[i].createDateToString+"</td>";
						rows += "<td>"+result[i].view+"</td>";
						rows += "<td>"+result[i].likes+"</td>";
						rows += "</tr>";
					}
				} else {
					totalCnt = 1;
					totalPageNo = Math.ceil(totalCnt/20);					
					rows += '<tr><td colspan="6" class="text-center">게시글이 존재하지 않습니다.</td></tr>';
				}
				$list.append(rows);				
				
				//pagination
				totalBlocks = Math.ceil(totalPageNo/nav);
				currentBlock = Math.ceil(currentPageNo/nav);
				beginPage = ((currentBlock-1)*nav)+1;
				endPage = currentBlock*nav;		
				 
				pagination = "<tr><td colspan='6' style='text-align: center;'><nav>";
			    pagination += "<ul class='pagination'>";
				if(currentBlock != 1){
				    pagination += "<li><a href='#' aria-label='Previous'>";
				    pagination += "<span aria-hidden='true'>&laquo;</span></a></li>";
				}
				if(currentBlock == totalBlocks) {
					beginPage = ((totalBlocks-1)*nav)+1;
					endPage = totalPageNo;
				}
				for (var i=beginPage; i<=endPage; i++) {
					if (currentPageNo == i){
						pagination += "<li><a href='#' class='active'>"+i+"</a></li>";
					} else {
						pagination += "<li><a href='#'>"+i+"</a></li>";
					}
				}
				if(currentBlock != totalBlocks){
				    pagination += "<li><a href='#' aria-label='Next'>";
				    pagination += "<span aria-hidden='true'>&raquo;</span></a></li>";
				}
			    pagination += "</ul></nav></td></tr>";
			    $paging.append(pagination);	
			}
		});
	}
	
	//$paging pagination 클릭한경우
	$paging.on('click', 'a', function(){
		currentPageNo = $(this).text();
		getAllTogethers();
		location.href='#locationTop';
		return false;
	});		
	$paging.on('click', 'a[aria-label="Previous"]', function(){
		currentBlock = currentBlock == 1 ? currentBlock : currentBlock-1;
		currentPageNo = ((currentBlock-1)*nav)+1;	
		getAllTogethers();
		location.href='#locationTop';
		return false;
	});		
	$paging.on('click', 'a[aria-label="Next"]', function(){
		currentBlock = currentBlock == totalBlocks ? totalBlocks : currentBlock+1;
		currentPageNo = ((currentBlock-1)*nav)+1;		
		getAllTogethers();
		location.href='#locationTop';
		return false;
	});		
	
	//검색 버튼을 클릭한 경우
	$('#searchBtn').click(function() {
 		var search1 = $('select[name=searchBy]').val();
		var search2 = $('input[name=keyword]').val();
		
		if(search1 == 'all') {
			alert('검색기준을 선택하세요');
			return false;
		}
		if(search2 == '') {
			alert('검색어를 입력하세요');
			return false;
		}
		currentModalPageNo = 1;
		searchBy = search1;
		keyword = search2;
		getAllTogethers();		
	})
	
	//오른쪽 메뉴 중간 : 참여수 탑5 게시글
	getTopJoin();
	function getTopJoin() {
		$.ajax({
			type: 'GET',
			url: '/together/getTopJoin.do',
			dataType: 'json',
			success: function(result) {
				$joinList.empty();
				var rows = "";
				if(result.length != 0) {
					$.each(result, function(index, board) {
						rows += "<div class='row' style='margin-bottom: 10px;'>";
						rows += "<div class='col-sm-2'><img src='/resources/images/profile/"+board.profile+"' width='50px;' height='50px;'/></div>"
						rows += "<div class='col-sm-10'>";
						rows += "<p style='margin-top: 3px; margin-bottom: 3px;'><label class='label label-warning'>참여해요! ("+board.together+")</label></p>";
						rows += "<a href='#' style='color: #ac7339;'><strong>"+board.userId+" </strong></a>";
						rows += "<a href='#' id='title-"+board.no+"'>"+board.titleWithDots+"</a> <span style='color: #999999;'><small>"+board.createDateToString+"</small></span>";
						rows += "</div>";
						rows += "</div>";
					})
				} else {
					rows += '<tr><td colspan="6" class="text-center">게시글이 존재하지 않습니다.</td></tr>';
				}
				$joinList.append(rows);				
			}
		});
	}
	
	//오른쪽 메뉴 하단 : 좋아요수 탑 5 게시글
	getTopLikes();
	function getTopLikes() {
		$.ajax({
			type: 'GET',
			url: '/together/getTopLikes.do',
			dataType: 'json',
			success: function(result) {
				$likeList.empty();
				var rows = "";
				if(result.length != 0) {
					$.each(result, function(index, board) {
						rows += "<div class='row' style='margin-bottom: 10px;'>";
						rows += "<div class='col-sm-2'><img src='/resources/images/profile/"+board.profile+"' width='50px;' height='50px;'/></div>"
						rows += "<div class='col-sm-10'>";
						rows += "<p style='margin-top: 3px; margin-bottom: 3px;'><label class='label label-warning'>좋아요! ("+board.likes+")</label></p>";
						rows += "<a href='#' style='color: #ac7339;'><strong>"+board.userId+" </strong></a>";
						rows += "<a href='#' id='title-"+board.no+"'>"+board.titleWithDots+"</a> <span style='color: #999999;'><small>"+board.createDateToString+"</small></span>";
						rows += "</div>";
						rows += "</div>";
					})
				} else {
					rows += '<tr><td colspan="6" class="text-center">게시글이 존재하지 않습니다.</td></tr>';
				}
				$likeList.append(rows);				
			}
		});
	}
	
	//목록으로
	$('.container').on('click', '#toListBtn', function() {
		toList();
	});
	function toList() {
		getAllTogethers();
		$('#newBoardBtn').css('display', 'block');		
		$('#toListBtn').css('display', 'none');
		$('#detailBox').css('display', 'none');        
		$('.listBox').css('display', 'block');    
		$('#replyContents').val('');
	}

	//게시글 상세내용(제목 클릭시)
	$('.container').on('click', '[id^=title-]', function() {
		bno = $(this).attr('id').replace('title-', '').trim();
		getBoardDetail();
		location.href='#locationTop';
	});
	function getBoardDetail() {
		$.ajax({
			type: 'GET',
			url: '/together/getBoardDetail.do',
			data: {no: bno},
			async: false,
			dataType: 'json',
			success: function(result) {
				var hasJoined = result.hasJoined;
				var hasLiked = result.hasLiked;
				var detail = result.boardDetail;
				var replyCnt = result.replyCnt;
				var writer = detail.userId;
				
				//목록버튼 보이기
				$('#newBoardBtn').css('display', 'none');
				$('#toListBtn').css('display', 'block');
				
				//동행버튼 보이기
				if(hasJoined == 0) {
					$('#cancelJoin').css('display', 'none');
					$('#addJoin').css('display', 'block');
				} else {
					$('#addJoin').css('display', 'none');
					$('#cancelJoin').css('display', 'block');
				}
				
				//좋아요버튼 보이기
				if(hasLiked == 0) {
					$('span#user-unlike').css('display', 'none');
					$('span#user-like').css('display', 'block');
				} else {
					$('span#user-like').css('display', 'none');
					$('span#user-unlike').css('display', 'block');
				}
				
				//작성자거나 관리자면, 보여주기
				$('#user-modify').css('display', 'none');
				$('#user-delete').css('display', 'none');
				if(loginId == writer || loginStatus == 'ADMIN') {
					$('#user-modify').css('display', 'block');
					$('#user-delete').css('display', 'block');
				}
				
				//게시글내용 보이기
				$('.listBox').css('display', 'none');    				
				$('#detailBox').css('display', 'block');
				$('#detailTitle').text(detail.title);
				$('#detailWriter').text(detail.userId);
				$('#detailCD').text(detail.createDateToString);
				$('#detailViews').text(detail.view);	
				$('[id^=detailLikes]').text(detail.likes);
				$('.detailMiddle').text(detail.contents);
				$('#joinCnt').text(detail.together);
				$('#replyCnt').text('('+replyCnt+')');
				
				//댓글 가져오기
				$('#replyContents').text('');
				getAllReplys();				
			}
		});
	}
	
	//해당 게시글의 댓글 가져오기
	function getAllReplys() {
		$detailReply.empty();
		$.ajax({
			type: 'GET',
			url: '/together/getAllReplys.do',
			data: {no: bno},
			dataType: 'json',
			success: function(result) {
				var rows = "";
				if(result.length == 0) {
					repCnt = 0;
					rows += '<tr><td colspan="6" class="text-center" style="font-size: 12px; padding-top: 20px;">댓글이 존재하지 않습니다.</td></tr>';
				} else {
					repCnt = result.length;
					$.each(result, function(index, reply) {
						rows += "<tr id='rep-"+reply.repNo+"'>";
						rows += "<th style='padding: 20px;'>";
						rows += "<img src='/resources/images/profile/"+reply.profile+"' width=50px; height=50px;/>";
						rows += "</th>";
						rows += "<th>";
						rows += "<span class='row' style='font-size: 12px;'>"+reply.userId+" <small style='color: #a6a6a6; margin-right: 10px;'>"+reply.createDateToString+"</small></span>";
						if(reply.status == 'REPORT') {
							rows += "<span class='row' style='font-size: 12px; display: block; font-weight: lighter; margin: 0px; color: #b30000;'> 신고된 댓글 입니다. </span>";
						} else {
							rows += "<span class='row' id='repContents' style='font-size: 12px; display: block; font-weight: lighter; margin: 0px;'>"+reply.contents+"</span>";
							rows += "<span class='row' id='orgContents' style='display: none;'><textarea class='form-control' rows='3' style='font-size: 12px; font-weight: lighter; width: 95%; margin-left: 10px;'>"+reply.contents+"</textarea></span>";
							rows += "<span class='row' id='reportedContents' style='font-size: 12px; display: none; font-weight: lighter; margin: 0px; color: #b30000;'> 신고된 댓글 입니다. </span>";
						}
						if(loginId == reply.userId || loginStatus == 'ADMIN') {
							rows += "<span class='pull-right form-inline' id='modifyBox' style='display: block; margin-top: 10px;'>";
							rows += "<button class='btn btn-xs btn-default' id='modifyRep' style='margin-right: 5px;'>수정</button>";
							rows += "<button class='btn btn-xs btn-danger' id='delRep'>삭제</button>";
							rows += "</span>";
							rows += "<span class='pull-right form-inline' id='modifyAddBox' style='display: none; margin-top: 10px;'>";
							rows += "<button class='btn btn-xs btn-warning' id='modifyRepAdd' style='margin-right: 5px;'>등록</button>";
							rows += "<button class='btn btn-xs btn-default' id='modifyRepCancel'>취소</button>";
							rows += "</span>";
						} else {
							rows += "<span class='pull-right' style='margin-top: 10px;'>";
							if(reply.status == 'NORMAL') {
								rows += "<button class='btn btn-xs btn-danger' id='reportRep'>신고</button>";
							} else {
								rows += "<button class='btn btn-xs btn-danger' disabled>신고</button>";
							}
							rows += "</span>";
						}
						rows += "</th>";
						rows += "</tr>";
					})	
				}
				$detailReply.append(rows);
			}
		});		
	}
	
	//해당 글 좋아요하기
	$('.container').on('click', '#user-like', function() {
		$.ajax({
			type: 'POST',
			url: '/together/likeBoard.do',
			data: {no: bno},
			complete: function() {
				var currLikes = parseInt($('[id^=detailLikes]').first().text());
				$('[id^=detailLikes]').text(currLikes+1);
				$('span#user-like').css('display', 'none');
				$('span#user-unlike').css('display', 'block');
			}
		});
	})

	//해당 글 좋아요 취소하기
	$('.container').on('click', '#user-unlike', function() {
		$.ajax({
			type: 'POST',
			url: '/together/unlikeBoard.do',
			data: {no: bno},
			complete: function() {
				var currLikes = parseInt($('[id^=detailLikes]').first().text());
				$('[id^=detailLikes]').text(currLikes-1);
				$('span#user-like').css('display', 'block');
				$('span#user-unlike').css('display', 'none');
			}
		});
	})
	
	//해당 글 동행 참여하기
	$('.container').on('click', '#addJoin', function() {
		$.ajax({
			type: 'POST',
			url: '/together/addJoin.do',
			data: {no: bno},
			complete: function() {
				var currJoin = parseInt($('#joinCnt').text());
				$('#joinCnt').text(currJoin+1);
				$('#addJoin').css('display', 'none');
				$('#cancelJoin').css('display', 'block');				
			}
		});
	});

	//해당 글 동행 참여 취소하기
	$('.container').on('click', '#cancelJoin', function() {
		$.ajax({
			type: 'POST',
			url: '/together/cancelJoin.do',
			data: {no: bno},
			complete: function() {
				var currJoin = parseInt($('#joinCnt').text());
				$('#joinCnt').text(currJoin-1)				
				$('#addJoin').css('display', 'block');
				$('#cancelJoin').css('display', 'none');				
			}
		});
	});

	//글 작성시 땅콩 +3
	
	
	
	
	
	
	//글 수정 및 삭제
	
	
	
	
	
	
	//댓글 작성시 땅콩 +1
	$('.container').on('click', 'div#addReply', function() {
		var contents = $('#replyContents').val();
		if(contents == '') {
			alert('댓글을 입력하세요.');
			return false;
		} 
		$.ajax({
			type: 'POST',
			url: '/together/addReply.do',
			data: {no: bno, contents: contents},
			dataType: 'json',
			success: function(reply) {
				if(repCnt == 0) {
					$detailReply.empty();
				}
				var rows = "<tr id='rep-"+reply.repNo+"'>";
				rows += "<th style='padding: 20px;'>";
				rows += "<img src='/resources/images/profile/"+reply.profile+"' width=50px; height=50px;/>";
				rows += "</th>";
				rows += "<th>";
				rows += "<span class='row' style='font-size: 12px;'>"+reply.userId+" <small style='color: #a6a6a6; margin-right: 10px;'>"+reply.createDateToString+"</small></span>";
				if(reply.status == 'REPORT') {
					rows += "<span class='row' style='font-size: 12px; display: block; font-weight: lighter; margin: 0px; color: #b30000;'> 신고된 댓글 입니다. </span>";
				} else {
					rows += "<span class='row' id='repContents' style='font-size: 12px; display: block; font-weight: lighter; margin: 0px;'>"+reply.contents+"</span>";
					rows += "<span class='row' id='orgContents' style='display: none;'><textarea class='form-control' rows='3' style='font-size: 12px; font-weight: lighter; width: 95%; margin-left: 10px;'>"+reply.contents+"</textarea></span>";
					rows += "<span class='row' id='reportedContents' style='font-size: 12px; display: none; font-weight: lighter; margin: 0px; color: #b30000;'> 신고된 댓글 입니다. </span>";
				}
				if(loginId == reply.userId || loginStatus == 'ADMIN') {
					rows += "<span class='pull-right form-inline' id='modifyBox' style='display: block; margin-top: 10px;'>";
					rows += "<button class='btn btn-xs btn-default' id='modifyRep' style='margin-right: 5px;'>수정</button>";
					rows += "<button class='btn btn-xs btn-danger' id='delRep'>삭제</button>";
					rows += "</span>";
					rows += "<span class='pull-right form-inline' id='modifyAddBox' style='display: none; margin-top: 10px;'>";
					rows += "<button class='btn btn-xs btn-warning' id='modifyRepAdd' style='margin-right: 5px;'>등록</button>";
					rows += "<button class='btn btn-xs btn-default' id='modifyRepCancel'>취소</button>";
					rows += "</span>";
				} else {
					rows += "<span class='pull-right' style='margin-top: 10px;'>";
					if(reply.status == 'NORMAL') {
						rows += "<button class='btn btn-xs btn-danger' id='reportRep'>신고</button>";
					} else {
						rows += "<button class='btn btn-xs btn-danger' disabled>신고</button>";
					}
					rows += "</span>";
				}
				rows += "</th>";
				rows += "</tr>";			
				$detailReply.append(rows);
			}
		});
		$('#replyContents').val('');
	});
	
	//댓글 수정
	$('.detailReply').on('click', '#modifyRep', function() {
		var $tr = $(this).parents('tr')
		repNo = $(this).parents('tr').attr('id').replace('rep-','').trim();
		$('span#repContents').css('display', 'block');	// 나머지 댓글 span 다 보이기
		$('span#orgContents').css('display', 'none');	// 해당 댓글입력 textarea 다 가리기
		$('span#modifyBox').css('display', 'block'); 	// 나머지 댓글 수정버튼 다 보이기
		$('span#modifyAddBox').css('display', 'none'); 	// 나머지 댓글 등록버튼 다 가리기
		
		$tr.find('#repContents').css('display', 'none');	// 해당 댓글 span 가리기
		$tr.find('#orgContents').css('display', 'block');	// 해당 댓글입력 textarea 보이게
		$tr.find('#modifyBox').css('display', 'none'); 		// 해당 댓글 수정버튼 가리기
		$tr.find('#modifyAddBox').css('display', 'block');	// 해당 댓글 등록버튼 보이기
	});
		
	//수정된 댓글 등록
	$('.detailReply').on('click', '#modifyRepAdd', function() {
		var $tr = $(this).parents('tr');
		var modifiedRep = $tr.find('#orgContents').find('textarea').val();
		if(modifiedRep == '') {
			alert('댓글을 입력하세요.');
			return false;
		}
		$.ajax({
			type: 'POST',
			url: '/together/modifyReply.do',
			data: {no: repNo, contents: modifiedRep},
			dataType: 'json',
			success: function(result) {
				console.log(result);
				$tr.find('#repContents').text(result.contents);
				$tr.find('#orgContents').find('textarea').text(result.contents);
				$('span#repContents').css('display', 'block');	// 나머지 댓글 span 다 보이기
				$('span#orgContents').css('display', 'none');	// 해당 댓글입력 textarea 다 가리기
				$('span#modifyBox').css('display', 'block'); 	// 나머지 댓글 수정버튼 다 보이기
				$('span#modifyAddBox').css('display', 'none'); 	// 나머지 댓글 등록버튼 다 가리기					
			}
		});
	});
		
	//댓글 수정 도중 취소 버튼
	$('.detailReply').on('click', '#modifyRepCancel', function() {
		var $tr = $(this).parents('tr');
		//댓글 원상복구
		var recovery = $tr.find('#repContents').text();
		$tr.find('#orgContents').find('textarea').val(recovery);
		$('span#repContents').css('display', 'block');	// 나머지 댓글 span 다 보이기
		$('span#orgContents').css('display', 'none');	// 해당 댓글입력 textarea 다 가리기
		$('span#modifyBox').css('display', 'block'); 	// 나머지 댓글 수정버튼 다 보이기
		$('span#modifyAddBox').css('display', 'none'); 	// 나머지 댓글 등록버튼 다 가리기		
	});
	
	//댓글 삭제
	$('.detailReply').on('click', '#delRep', function() {
		var $tr = $(this).parents('tr');
		repNo = $tr.attr('id').replace('rep-','').trim();
		$.ajax({
			type: 'POST',
			url: '/together/delReply.do',
			data: {no: repNo},
			complete: function() {
				$tr.hide();
			}
		});
	});
	
	//댓글 신고
	$('.detailReply').on('click', '#reportRep', function() {
		var $tr = $(this).parents('tr');
		repNo = $tr.attr('id').replace('rep-','').trim();
		$.ajax({
			type: 'POST',
			url: '/together/reportReply.do',
			data: {no: repNo},
			complete: function() {
				$tr.find('#reportRep').attr('disabled', true);
				$tr.find('#reportedContents').css('display', 'block');	// 신고댓글 표시
				$tr.find('#repContents').css('display', 'none');	// 해당 댓글 span 가리기
				$tr.find('#orgContents').css('display', 'none');	// 해당 댓글입력 textarea 가리기
			}
		});
	});
	
	//내가 동행참여한 글 리스트 한번에 보기 (모달)
	
	
	
	
})
</script>
</html>